var B=Object.defineProperty;var W=(n,s,e)=>s in n?B(n,s,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[s]=e;var E=(n,s,e)=>(W(n,typeof s!="symbol"?s+"":s,e),e),P=(n,s,e)=>{if(!s.has(n))throw TypeError("Cannot "+e)};var g=(n,s,e)=>(P(n,s,"read from private field"),e?e.call(n):s.get(n)),j=(n,s,e)=>{if(s.has(n))throw TypeError("Cannot add the same private member more than once");s instanceof WeakSet?s.add(n):s.set(n,e)},w=(n,s,e,t)=>(P(n,s,"write to private field"),t?t.call(n,e):s.set(n,e),e);var U=(n,s,e)=>(P(n,s,"access private method"),e);import{s as H,c as K,n as y,d as V,u as z,g as Q,e as X}from"../chunks/scheduler.bc65eea2.js";import{S as Y,i as Z,e as x,a as ee,d as G,t as R,f as te}from"../chunks/index.cf715be0.js";import{h as se,u as re}from"../chunks/await_block.b32c7e6c.js";import{g as L}from"../chunks/navigation.d54ae825.js";import{b as N}from"../chunks/paths.da1ac243.js";import{g as ne,r as ie}from"../chunks/runtime.esm.57956297.js";import{s as q,a as ae,b as ce,c as oe}from"../chunks/context.58a48396.js";import{D as he}from"../chunks/util.892acc65.js";import{w as A}from"../chunks/index.27f04a12.js";import"../chunks/i18n.e9d193b6.js";const le=!0,ue=!1,xe=Object.freeze(Object.defineProperty({__proto__:null,prerender:le,ssr:ue},Symbol.toStringTag,{value:"Module"}));class pe{constructor(s){E(this,"cache",{channels:new Map,emojis:new Map,members:new Map,servers:new Map,users:new Map});E(this,"token");s&&(this.token=s)}async req(s,e,t){const r=await fetch(`https://api.revolt.chat${e}`,{method:s,body:t,headers:this.token==null?this.token:{"x-session-token":this.token}});if(r.status==401&&(localStorage.removeItem("session"),await L(`${N}/login`)),!r.ok)throw r.statusText;return r}async login(s){return this.req("POST","/auth/session/login",JSON.stringify(s)).then(e=>e.json())}async logout(){await this.req("POST","/auth/session/logout")}async revokeSession(s){await this.req("DELETE",`/auth/session/${s}`)}async revokeAllSessions(s){await this.req("DELETE",`/auth/session/all?revoke_self=${s}`)}async createServer(s){return this.req("POST","/servers/create",JSON.stringify(s)).then(e=>e.json())}async changeUsername(s,e){return this.req("PATCH","/users/@me/username",JSON.stringify({username:s,password:e})).then(t=>t.json())}async openDM(s){return this.req("GET",`/users/${s}/dm`).then(e=>e.json())}async joinCall(s){return this.req("POST",`/channels/${s}/join_call`).then(e=>e.json()).then(({token:e})=>e)}async acceptFriend(s){return this.req("PUT",`/channels/${s}/friend`).then(e=>e.json())}async removeFriend(s){return this.req("DELETE",`/users/${s}/friend`).then(e=>e.json())}async editServer(s,e){return this.req("PATCH",`/servers/${s}`,JSON.stringify(e)).then(t=>t.json())}async fetchChannel(s){const e=this.cache.channels.get(s);if(e==null){const t=await this.req("GET",`/channels/${s}`).then(r=>r.json());return this.cache.channels.set(t._id,t),t}return e}async fetchDirectMessages(){return this.req("GET","/users/dms").then(s=>s.json())}async ackMessage(s,e){await this.req("PUT",`/channels/${s}/ack/${e}`)}async fetchSettings(s){return this.req("POST","/sync/settings/fetch",JSON.stringify({keys:s})).then(e=>e.json())}async fetchMembers(s){return await this.req("GET",`/servers/${s}/members`).then(e=>e.json())}async fetchMessage(s,e){return this.req("GET",`/channels/${s}/messages/${e}`).then(t=>t.json())}async queryMessages(s,e){const t="?"+new URLSearchParams(Object.entries(e).map(([r,c])=>[r,c.toString()]));return this.req("GET",`/channels/${s}/messages${t}`).then(r=>r.json())}async sendMessage(s,e){return this.req("POST",`/channels/${s}/messages`,JSON.stringify(e)).then(t=>t.json())}async editMessage(s,e,t){return this.req("PATCH",`/channels/${s}/messages/${e}`,JSON.stringify(t)).then(r=>r.json())}async deleteMessage(s,e){await this.req("DELETE",`/channels/${s}/messages/${e}`)}async fetchServer(s){const e=this.cache.servers.get(s);if(e==null){const t=await this.req("GET",`/servers/${s}`).then(r=>r.json());return this.cache.servers.set(t._id,t),t}return e}async fetchSessions(){return this.req("GET","/auth/session/all").then(s=>s.json())}async fetchUser(s){const e=this.cache.users.get(s);if(e==null){const t=await this.req("GET",`/users/${s}`).then(r=>r.json());return this.cache.users.set(t._id,t),t}return e}async fetchUserProfile(s){return this.req("GET",`/users/${s}/profile`).then(e=>e.json())}}class fe{async uploadFile(s,e="attachments"){const t=new FormData;t.append("file",s);const{id:r}=await fetch(`https://autumn.revolt.chat/${e}`,{method:"POST",body:t}).then(c=>c.json());return r}}var J={exports:{}};(function(n){var s=Object.prototype.hasOwnProperty,e="~";function t(){}Object.create&&(t.prototype=Object.create(null),new t().__proto__||(e=!1));function r(l,i,o){this.fn=l,this.context=i,this.once=o||!1}function c(l,i,o,h,m){if(typeof o!="function")throw new TypeError("The listener must be a function");var d=new r(o,h||l,m),u=e?e+i:i;return l._events[u]?l._events[u].fn?l._events[u]=[l._events[u],d]:l._events[u].push(d):(l._events[u]=d,l._eventsCount++),l}function _(l,i){--l._eventsCount===0?l._events=new t:delete l._events[i]}function p(){this._events=new t,this._eventsCount=0}p.prototype.eventNames=function(){var i=[],o,h;if(this._eventsCount===0)return i;for(h in o=this._events)s.call(o,h)&&i.push(e?h.slice(1):h);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(o)):i},p.prototype.listeners=function(i){var o=e?e+i:i,h=this._events[o];if(!h)return[];if(h.fn)return[h.fn];for(var m=0,d=h.length,u=new Array(d);m<d;m++)u[m]=h[m].fn;return u},p.prototype.listenerCount=function(i){var o=e?e+i:i,h=this._events[o];return h?h.fn?1:h.length:0},p.prototype.emit=function(i,o,h,m,d,u){var v=e?e+i:i;if(!this._events[v])return!1;var a=this._events[v],k=arguments.length,S,f;if(a.fn){switch(a.once&&this.removeListener(i,a.fn,void 0,!0),k){case 1:return a.fn.call(a.context),!0;case 2:return a.fn.call(a.context,o),!0;case 3:return a.fn.call(a.context,o,h),!0;case 4:return a.fn.call(a.context,o,h,m),!0;case 5:return a.fn.call(a.context,o,h,m,d),!0;case 6:return a.fn.call(a.context,o,h,m,d,u),!0}for(f=1,S=new Array(k-1);f<k;f++)S[f-1]=arguments[f];a.fn.apply(a.context,S)}else{var F=a.length,C;for(f=0;f<F;f++)switch(a[f].once&&this.removeListener(i,a[f].fn,void 0,!0),k){case 1:a[f].fn.call(a[f].context);break;case 2:a[f].fn.call(a[f].context,o);break;case 3:a[f].fn.call(a[f].context,o,h);break;case 4:a[f].fn.call(a[f].context,o,h,m);break;default:if(!S)for(C=1,S=new Array(k-1);C<k;C++)S[C-1]=arguments[C];a[f].fn.apply(a[f].context,S)}}return!0},p.prototype.on=function(i,o,h){return c(this,i,o,h,!1)},p.prototype.once=function(i,o,h){return c(this,i,o,h,!0)},p.prototype.removeListener=function(i,o,h,m){var d=e?e+i:i;if(!this._events[d])return this;if(!o)return _(this,d),this;var u=this._events[d];if(u.fn)u.fn===o&&(!m||u.once)&&(!h||u.context===h)&&_(this,d);else{for(var v=0,a=[],k=u.length;v<k;v++)(u[v].fn!==o||m&&!u[v].once||h&&u[v].context!==h)&&a.push(u[v]);a.length?this._events[d]=a.length===1?a[0]:a:_(this,d)}return this},p.prototype.removeAllListeners=function(i){var o;return i?(o=e?e+i:i,this._events[o]&&_(this,o)):(this._events=new t,this._eventsCount=0),this},p.prototype.off=p.prototype.removeListener,p.prototype.addListener=p.prototype.on,p.prefixed=e,p.EventEmitter=p,n.exports=p})(J);var de=J.exports;const I=ne(de),me=30,ye=10;var b,M,O,T;class be extends I{constructor(){super();j(this,b,void 0);j(this,M,void 0);j(this,O,void 0);j(this,T,"idle")}get connectionState(){return g(this,T)}authenticate(e){w(this,b,new WebSocket(`wss://ws.revolt.chat?token=${e}`)),w(this,T,"connecting"),g(this,b).onopen=()=>{w(this,M,setInterval(()=>{this.send({type:"Ping",data:Date.now()}),w(this,O,setTimeout(()=>this.disconnect(),ye*1e3))},me*1e3))},g(this,b).onmessage=t=>this.handleMessage(JSON.parse(t.data.toString())),g(this,b).onclose=()=>this.disconnect()}handleMessage(e){switch(e.type){case"Ping":this.send({type:"Pong",data:e.data});return;case"Pong":clearTimeout(g(this,O));return;case"Error":this.emit("error",e),this.disconnect();return}switch(this.connectionState){case"connecting":if(e.type=="Ready")this.emit("serverEvent",e),w(this,T,"connected");else if(e.type!="Authenticated")throw new Error(`Received ${e.type} event from server in connecting state.`);break;case"connected":if(e.type=="Authenticated"||e.type=="Ready")throw new Error(`Received ${e.type} in connecting state.`);this.emit("serverEvent",e);break;default:throw new Error(`Received ${e.type} in ${this.connectionState} state.`)}}send(e){if(!g(this,b))throw new Error("Tried to send WS message when the connection was disconnected.");g(this,b).send(JSON.stringify(e))}disconnect(){if(!g(this,b))return;clearInterval(g(this,M));const e=g(this,b);w(this,b,void 0),e.close(),w(this,T,"disconnected")}}b=new WeakMap,M=new WeakMap,O=new WeakMap,T=new WeakMap;var $,D;class ge extends I{constructor(){super(...arguments);j(this,$);E(this,"api",new pe);E(this,"websocket",new be);E(this,"autumn",new fe);E(this,"user")}get ready(){return this.api.cache!=null}authenticate(e){this.api.token=e,this.websocket.authenticate(e),this.api.fetchUser("@me").then(t=>this.user=t),this.websocket.on("serverEvent",t=>U(this,$,D).call(this,t))}async destroy(){await this.api.logout(),this.api.token=void 0,this.websocket.disconnect(),this.api.cache={channels:new Map,emojis:new Map,members:new Map,servers:new Map,users:new Map}}}$=new WeakSet,D=function(e){switch(e.type){case"Bulk":{for(const t of e.v)U(this,$,D).call(this,t);break}case"Ready":{this.api.cache.users=new Map(e.users.map(t=>[t._id,t])),this.api.cache.channels=new Map(e.channels.map(t=>[t._id,t])),this.api.cache.servers=new Map(e.servers.map(t=>[t._id,t])),this.api.cache.members=new Map(e.members.map(t=>[t._id,t])),this.api.cache.emojis=new Map(e.emojis.map(t=>[t._id,t])),this.emit("Ready",e);break}case"ChannelCreate":{this.api.cache.channels.set(e._id,e),this.emit("ChannelCreate",e);break}case"ChannelDelete":{this.api.cache.channels.delete(e.id)&&this.emit("ChannelDelete",e);break}case"ChannelUpdate":{const t=this.api.cache.channels.get(e.id);if(t==null)return;if(e.clear!=null)for(const r of e.clear){if(t.channel_type!="Group"&&t.channel_type!="TextChannel"&&t.channel_type!="VoiceChannel")break;switch(r){case"Description":t.description=void 0;break;case"Icon":t.icon=void 0;break;case"DefaultPermissions":t.channel_type!="Group"&&(t.default_permissions=void 0);break}}for(const[r,c]of Object.entries(e.data))t[r]=c;this.api.cache.channels.set(e.id,t),this.emit("ChannelUpdate",e);break}case"ServerCreate":{for(const t of e.channels)this.api.cache.channels.set(t._id,t);this.api.cache.servers.set(e.id,e.server),this.emit("ServerCreate",e);break}case"ServerDelete":{const t=this.api.cache.servers.get(e.id);if(t==null)return;for(const r of t.channels)this.api.cache.channels.delete(r);this.api.cache.servers.delete(t._id),this.emit("ServerDelete",e);break}case"ServerUpdate":{const t=this.api.cache.servers.get(e.id);if(t==null)return;if(e.clear!=null)for(const r of e.clear)switch(r){case"Description":t.description=void 0;break;case"Icon":t.icon=void 0;break;case"Categories":t.categories=void 0;break;case"SystemMessages":t.system_messages=void 0;break;case"Banner":t.banner=void 0;break}for(const[r,c]of Object.entries(e.data))t[r]=c;this.api.cache.servers.set(e.id,t),this.emit("ServerUpdate",e);break}case"ChannelGroupJoin":{const t=this.api.cache.channels.get(e.id);if(t==null||t.channel_type!="Group")return;t.recipients.push(e.user),this.api.cache.channels.set(e.id,t),this.emit("ChannelGroupJoin",e);break}case"ChannelGroupLeave":{const t=this.api.cache.channels.get(e.id);if(t==null||t.channel_type!="Group")return;t.recipients=t.recipients.filter(r=>r!=e.user),this.api.cache.channels.set(e.id,t),this.emit("ChannelGroupJoin",e);break}case"ServerMemberUpdate":{const t=this.api.cache.members.get(e.id);if(t==null)return;if(e.clear!=null)for(const r of e.clear)switch(r){case"Nickname":t.nickname=void 0;break;case"Avatar":t.avatar=void 0;break;case"Roles":t.roles=void 0;break;case"Timeout":t.timeout=void 0}for(const[r,c]of Object.entries(e.data))t[r]=c;this.api.cache.members.set(t._id,t),this.emit("ServerMemberUpdate",e);break}case"ServerRoleUpdate":{const t=this.api.cache.servers.get(e.id);if(t==null||t.roles==null)return;for(const[r,c]of Object.entries(e.data))t.roles[r]=c;this.api.cache.servers.set(e.id,t);break}case"ServerRoleDelete":{const t=this.api.cache.servers.get(e.id);if(t==null||t.roles==null)return;t.roles=Object.fromEntries(Object.entries(t.roles).filter(([r])=>r!=e.role_id)),this.api.cache.servers.set(e.id,t),this.emit("ServerRoleDelete",e);break}case"UserUpdate":{const t=this.api.cache.users.get(e.id);if(t==null)return;if(e.clear!=null)for(const r of e.clear)switch(r){case"Avatar":{t.avatar=void 0;break}case"StatusText":{t.status!=null&&(t.status.text=void 0);break}case"StatusPresence":{t.status!=null&&(t.status.presence=void 0);break}case"ProfileContent":{t.profile!=null&&(t.profile.content=void 0);break}case"ProfileBackground":{t.profile!=null&&(t.profile.background=void 0);break}case"DisplayName":{t.display_name=void 0;break}}for(const[r,c]of Object.entries(e.data))t[r]=c;this.api.cache.users.set(e.id,t),this.emit("UserUpdate",e);break}case"UserRelationship":{this.api.cache.users.set(e.user._id,e.user),this.emit("UserRelationship",e);break}case"UserPresence":{const t=this.api.cache.users.get(e.id);if(t==null)return;t.online=e.online,this.api.cache.users.set(e.id,t),this.emit("UserPresence",e);break}case"UserPlatformWipe":{const t=this.api.cache.users.get(e.user_id);if(t==null)return;t.flags=e.flags,this.api.cache.users.set(e.user_id,t),this.emit("UserPlatformWipe",e);break}case"EmojiCreate":{this.api.cache.emojis.set(e._id,e),this.emit("EmojiCreate",e);break}case"EmojiDelete":{this.api.cache.emojis.delete(e.id)&&this.emit("EmojiDelete",e);break}case"Auth":case"UserSettingsUpdate":case"ServerMemberJoin":case"ServerMemberLeave":case"Message":case"MessageUpdate":case"MessageAppend":case"MessageDelete":case"MessageReact":case"MessageUnreact":case"MessageRemoveReaction":case"BulkMessageDelete":case"ChannelStartTyping":case"ChannelStopTyping":case"ChannelAck":this.emit(e.type,e);break}};function ve(n){return{c:y,l:y,m:y,p:y,i:y,o:y,d:y}}function _e(n){let s;const e=n[3].default,t=V(e,n,n[2],null);return{c(){t&&t.c()},l(r){t&&t.l(r)},m(r,c){t&&t.m(r,c),s=!0},p(r,c){t&&t.p&&(!s||c&4)&&z(t,e,r,r[2],s?X(e,r[2],c,null):Q(r[2]),null)},i(r){s||(G(t,r),s=!0)},o(r){R(t,r),s=!1},d(r){t&&t.d(r)}}}function ke(n){return{c:y,l:y,m:y,p:y,i:y,o:y,d:y}}function we(n){let s,e,t={ctx:n,current:null,token:null,hasCatch:!1,pending:ke,then:_e,catch:ve,blocks:[,,,]};return se(ie(),t),{c(){s=x(),t.block.c()},l(r){s=x(),t.block.l(r)},m(r,c){ee(r,s,c),t.block.m(r,t.anchor=c),t.mount=()=>s.parentNode,t.anchor=s,e=!0},p(r,[c]){n=r,re(t,n,c)},i(r){e||(G(t.block),e=!0)},o(r){for(let c=0;c<3;c+=1){const _=t.blocks[c];R(_)}e=!1},d(r){r&&te(s),t.block.d(r),t.token=null,t=null}}}function Se(n,s,e){let t,{$$slots:r={},$$scope:c}=s;const _=A(he);q(ae,_);const p=A(JSON.parse(localStorage.getItem("session")||"null"));K(n,p,i=>e(1,t=i)),q(ce,p);const l=new ge;return q(oe,l),n.$$set=i=>{"$$scope"in i&&e(2,c=i.$$scope)},n.$$.update=()=>{if(n.$$.dirty&2)if(t==null)l.websocket.disconnect();else{const{token:i}=t;l.authenticate(i)}n.$$.dirty&2&&t==null&&L(`${N}/login`)},[p,t,c,r]}class Ae extends Y{constructor(s){super(),Z(this,s,Se,we,H,{})}}export{Ae as component,xe as universal};
