var I=Object.defineProperty;var W=(n,t,e)=>t in n?I(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var O=(n,t,e)=>(W(n,typeof t!="symbol"?t+"":t,e),e),P=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)};var _=(n,t,e)=>(P(n,t,"read from private field"),e?e.call(n):t.get(n)),T=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},S=(n,t,e,s)=>(P(n,t,"write to private field"),s?s.call(n,e):t.set(n,e),e);var x=(n,t,e)=>(P(n,t,"access private method"),e);import{s as B,c as K,n as m,d as F,u as H,g as z,e as V}from"../chunks/scheduler.9b2bc230.js";import{S as Q,i as X,e as L,a as Y,d as N,t as G,f as Z}from"../chunks/index.6c81ac7e.js";import{h as ee,u as te,D as se}from"../chunks/util.591b1810.js";import{s as R,a as ne,b as re,c as ie}from"../chunks/context.3f5e8c52.js";import{w as A}from"../chunks/index.cace4c42.js";import{g as oe,w as ae}from"../chunks/runtime.esm.a3f7b725.js";import"../chunks/i18n.776dbc59.js";import{g as ce}from"../chunks/navigation.40791037.js";const le=!0,he=!1,Pe=Object.freeze(Object.defineProperty({__proto__:null,prerender:le,ssr:he},Symbol.toStringTag,{value:"Module"}));var D={exports:{}};(function(n){var t=Object.prototype.hasOwnProperty,e="~";function s(){}Object.create&&(s.prototype=Object.create(null),new s().__proto__||(e=!1));function i(h,r,a){this.fn=h,this.context=r,this.once=a||!1}function l(h,r,a,c,v){if(typeof a!="function")throw new TypeError("The listener must be a function");var d=new i(a,c||h,v),u=e?e+r:r;return h._events[u]?h._events[u].fn?h._events[u]=[h._events[u],d]:h._events[u].push(d):(h._events[u]=d,h._eventsCount++),h}function y(h,r){--h._eventsCount===0?h._events=new s:delete h._events[r]}function f(){this._events=new s,this._eventsCount=0}f.prototype.eventNames=function(){var r=[],a,c;if(this._eventsCount===0)return r;for(c in a=this._events)t.call(a,c)&&r.push(e?c.slice(1):c);return Object.getOwnPropertySymbols?r.concat(Object.getOwnPropertySymbols(a)):r},f.prototype.listeners=function(r){var a=e?e+r:r,c=this._events[a];if(!c)return[];if(c.fn)return[c.fn];for(var v=0,d=c.length,u=new Array(d);v<d;v++)u[v]=c[v].fn;return u},f.prototype.listenerCount=function(r){var a=e?e+r:r,c=this._events[a];return c?c.fn?1:c.length:0},f.prototype.emit=function(r,a,c,v,d,u){var b=e?e+r:r;if(!this._events[b])return!1;var o=this._events[b],w=arguments.length,k,p;if(o.fn){switch(o.once&&this.removeListener(r,o.fn,void 0,!0),w){case 1:return o.fn.call(o.context),!0;case 2:return o.fn.call(o.context,a),!0;case 3:return o.fn.call(o.context,a,c),!0;case 4:return o.fn.call(o.context,a,c,v),!0;case 5:return o.fn.call(o.context,a,c,v,d),!0;case 6:return o.fn.call(o.context,a,c,v,d,u),!0}for(p=1,k=new Array(w-1);p<w;p++)k[p-1]=arguments[p];o.fn.apply(o.context,k)}else{var j=o.length,$;for(p=0;p<j;p++)switch(o[p].once&&this.removeListener(r,o[p].fn,void 0,!0),w){case 1:o[p].fn.call(o[p].context);break;case 2:o[p].fn.call(o[p].context,a);break;case 3:o[p].fn.call(o[p].context,a,c);break;case 4:o[p].fn.call(o[p].context,a,c,v);break;default:if(!k)for($=1,k=new Array(w-1);$<w;$++)k[$-1]=arguments[$];o[p].fn.apply(o[p].context,k)}}return!0},f.prototype.on=function(r,a,c){return l(this,r,a,c,!1)},f.prototype.once=function(r,a,c){return l(this,r,a,c,!0)},f.prototype.removeListener=function(r,a,c,v){var d=e?e+r:r;if(!this._events[d])return this;if(!a)return y(this,d),this;var u=this._events[d];if(u.fn)u.fn===a&&(!v||u.once)&&(!c||u.context===c)&&y(this,d);else{for(var b=0,o=[],w=u.length;b<w;b++)(u[b].fn!==a||v&&!u[b].once||c&&u[b].context!==c)&&o.push(u[b]);o.length?this._events[d]=o.length===1?o[0]:o:y(this,d)}return this},f.prototype.removeAllListeners=function(r){var a;return r?(a=e?e+r:r,this._events[a]&&y(this,a)):(this._events=new s,this._eventsCount=0),this},f.prototype.off=f.prototype.removeListener,f.prototype.addListener=f.prototype.on,f.prefixed=e,f.EventEmitter=f,n.exports=f})(D);var ue=D.exports;const J=oe(ue);class fe{constructor(t){O(this,"cache");O(this,"token");this.cache={channels:[],emojis:[],members:[],servers:[],users:[]},t&&(this.token=t)}async req(t,e,s,i){const l=await fetch(`https://api.revolt.chat${e}`,{method:t,body:i,headers:this.token==null?this.token:{"x-session-token":this.token}});if(!l.ok)throw l;if(l.body==null&&s)throw new Error(`expected response from route ${e}`);return l.json()}login(t){return this.req("POST","/auth/session/login",!0,JSON.stringify(t))}logout(){return this.req("POST","/auth/session/logout",!1)}deleteSession(t){return this.req("DELETE",`/auth/session/${t}`,!1)}createServer(t){return this.req("POST","/servers/create",!0,JSON.stringify(t))}async fetchChannel(t){var e;return((e=this.cache)==null?void 0:e.channels.find(s=>s._id==t))??this.req("GET",`/channels/${t}`,!0)}setSettings(t){return this.req("POST",`/sync/settings/set?timestamp=${Date.now()}`,!1,JSON.stringify(t))}fetchDirectMessages(){return this.req("GET","/users/dms",!0)}ackMessage(t,e){return this.req("PUT",`/channels/${t}/ack/${e}`,!1)}async fetchSettings(t){return this.req("POST","/sync/settings/fetch",!0,JSON.stringify({keys:t}))}fetchMembers(t){return this.req("GET",`/servers/${t}/members`,!0)}async fetchMember(t,e,s){var l;const i=()=>this.req("GET",`/servers/${t}/members/${e}`,!0);return s==null?i():((l=this.cache)==null?void 0:l.members.find(y=>y._id.server==t&&y._id.user==s))??i()}fetchMessage(t,e){return this.req("GET",`/channels/${t}/messages/${e}`,!0)}queryMessages(t,e){const s="?"+new URLSearchParams(Object.entries(e).map(([i,l])=>[i,l.toString()]));return this.req("GET",`/channels/${t}/messages${s}`,!0)}sendMessage(t,e){return this.req("POST",`/channels/${t}/messages`,!0,JSON.stringify(e))}editMessage(t,e,s){return this.req("PATCH",`/channels/${t}/messages/${e}`,!0,JSON.stringify(s))}deleteMessage(t,e){return this.req("DELETE",`/channels/${t}/messages/${e}`,!1)}async fetchServer(t){var e;return((e=this.cache)==null?void 0:e.servers.find(s=>s._id==t))??await this.req("GET",`/servers/${t}`,!0)}fetchSessions(){return this.req("GET","/auth/session/all",!0)}async fetchUser(t){var e;return((e=this.cache)==null?void 0:e.users.find(s=>s._id==t))??this.req("GET",`/users/${t}`,!0)}fetchUserProfile(t){return this.req("GET",`/users/${t}/profile`,!0)}}const pe=30,de=10;var g,C,q,E;class ve extends J{constructor(){super();T(this,g,void 0);T(this,C,void 0);T(this,q,void 0);T(this,E,"idle")}get connectionState(){return _(this,E)}authenticate(e){S(this,g,new WebSocket(`wss://ws.revolt.chat?version=1&format=json&token=${e}`)),S(this,E,"connecting"),_(this,g).onopen=()=>{S(this,C,setInterval(()=>{this.send({type:"Ping",data:Date.now()}),S(this,q,setTimeout(()=>this.disconnect(),de*1e3))},pe*1e3))},_(this,g).onmessage=s=>this.handleMessage(JSON.parse(s.data.toString())),_(this,g).onclose=()=>this.disconnect()}handleMessage(e){switch(e.type){case"Ping":this.send({type:"Pong",data:e.data});return;case"Pong":clearTimeout(_(this,q));return;case"Error":this.emit("error",e),this.disconnect();return}switch(this.connectionState){case"connecting":if(e.type==="Ready")this.emit("serverEvent",e),S(this,E,"connected");else if(e.type!="Authenticated")throw new Error(`Received ${e.type} event from server in connecting state.`);break;case"connected":if(e.type==="Authenticated"||e.type==="Ready")throw new Error(`Received ${e.type} in connecting state.`);this.emit("serverEvent",e);break;default:throw new Error(`Received ${e.type} in ${this.connectionState} state.`)}}send(e){if(!_(this,g))throw new Error("Tried to send WS message when the connection was disconnected.");_(this,g).send(JSON.stringify(e))}disconnect(){if(!_(this,g))return;clearInterval(_(this,C));const e=_(this,g);S(this,g,void 0),e.close(),S(this,E,"disconnected")}}g=new WeakMap,C=new WeakMap,q=new WeakMap,E=new WeakMap;var M,U;class me extends J{constructor(){super();T(this,M);O(this,"api");O(this,"websocket");this.api=new fe,this.websocket=new ve}get ready(){return this.api.cache!=null}authenticate(e){this.api.token=e,this.websocket.authenticate(e),this.websocket.on("serverEvent",s=>x(this,M,U).call(this,s))}}M=new WeakSet,U=function(e){switch(e.type){case"Bulk":for(const s of e.v)x(this,M,U).call(this,s);break;case"Ready":this.api.cache=e,this.emit("Ready",e);break;case"Message":case"MessageUpdate":case"MessageAppend":case"MessageDelete":case"MessageReact":case"MessageUnreact":case"MessageRemoveReaction":case"BulkMessageDelete":case"ChannelCreate":case"ChannelUpdate":case"ChannelDelete":case"ChannelGroupJoin":case"ChannelGroupLeave":case"ChannelStartTyping":case"ChannelStopTyping":case"ChannelAck":case"ServerCreate":case"ServerUpdate":case"ServerDelete":case"ServerMemberUpdate":case"ServerMemberJoin":case"ServerMemberLeave":case"ServerRoleUpdate":case"ServerRoleDelete":case"UserUpdate":case"UserRelationship":case"UserPresence":case"UserSettingsUpdate":case"UserPlatformWipe":case"EmojiCreate":case"EmojiDelete":case"Auth":this.emit(e.type,e);break}};function ge(n){return{c:m,l:m,m,p:m,i:m,o:m,d:m}}function ye(n){let t;const e=n[3].default,s=F(e,n,n[2],null);return{c(){s&&s.c()},l(i){s&&s.l(i)},m(i,l){s&&s.m(i,l),t=!0},p(i,l){s&&s.p&&(!t||l&4)&&H(s,e,i,i[2],t?V(e,i[2],l,null):z(i[2]),null)},i(i){t||(N(s,i),t=!0)},o(i){G(s,i),t=!1},d(i){s&&s.d(i)}}}function _e(n){return{c:m,l:m,m,p:m,i:m,o:m,d:m}}function be(n){let t,e,s={ctx:n,current:null,token:null,hasCatch:!1,pending:_e,then:ye,catch:ge,blocks:[,,,]};return ee(ae(),s),{c(){t=L(),s.block.c()},l(i){t=L(),s.block.l(i)},m(i,l){Y(i,t,l),s.block.m(i,s.anchor=l),s.mount=()=>t.parentNode,s.anchor=t,e=!0},p(i,[l]){n=i,te(s,n,l)},i(i){e||(N(s.block),e=!0)},o(i){for(let l=0;l<3;l+=1){const y=s.blocks[l];G(y)}e=!1},d(i){i&&Z(t),s.block.d(i),s.token=null,s=null}}}function we(n,t,e){let s,{$$slots:i={},$$scope:l}=t;const y=A(se);R(ne,y);const f=A(JSON.parse(localStorage.getItem("session")||"null"));K(n,f,r=>e(1,s=r)),R(re,f);const h=new me;return R(ie,h),n.$$set=r=>{"$$scope"in r&&e(2,l=r.$$scope)},n.$$.update=()=>{if(n.$$.dirty&2){const r=s==null?void 0:s.token;r?h.authenticate(r):h.websocket.disconnect()}n.$$.dirty&2&&s==null&&ce("/login")},[f,s,l,i]}class xe extends Q{constructor(t){super(),X(this,t,we,be,B,{})}}export{xe as component,Pe as universal};
